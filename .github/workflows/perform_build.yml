# SPDX-License-Identifier: BSD-2-Clause
# X-SPDX-Copyright-Text: (c) Copyright 2024 Advanced Micro Devices, Inc.

name: "perform_build"

on: push

jobs:
  extract_branch_info:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      tcpdirectBranch: ${{ steps.tcpdirectBranch.outputs.branch }}
      onloadBranch: ${{ steps.onloadBranch.outputs.branch }}
      packetDrillBranch: ${{ steps.packetDrillBranch.outputs.branch }}
    steps:
      - name: tcpdirect
        uses: actions/checkout@v4
        with:
          path: tcpdirect

      - name: Install yq
        run: |
           sudo apt update
           sudo apt install python3 python3-pip jq
           pip3 install yq

      - name: Extract TCPDirect branch name
        id: tcpdirectBranch
        run: echo "branch=$(yq -r '.products.TCPDirect.version' < $GITHUB_WORKSPACE/tcpdirect/versions.yaml)" >> "$GITHUB_OUTPUT"


      - name: Extract onload branch name
        id: onloadBranch
        run: echo "branch=$(yq -r '.products.Onload.version' < $GITHUB_WORKSPACE/tcpdirect/versions.yaml)" >> "$GITHUB_OUTPUT"

      - name: Extract packetDrill branch name
        id: packetDrillBranch
        run: echo "branch=$(yq -r '.products.Packetdrill.version' < $GITHUB_WORKSPACE/tcpdirect/versions.yaml)" >> "$GITHUB_OUTPUT"


  perform_build_and_test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: extract_branch_info
    steps:

      - name: tcpdirect
        uses: actions/checkout@v4
        with:
          path: tcpdirect

      - name: onload checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/onload_internal
          path: onload_internal
          ssh-key: ${{ secrets.ONLOAD_INTERNAL_PRIVATE_KEY }}
          ref: ${{ needs.extract_branch_info.outputs.onloadBranch }}

      - name: packetdrill checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/packetdrill-tcpdirect
          path: packetdrill-tcpdirect
          ssh-key: ${{ secrets.PACKET_DRILL_PRIVATE_KEY }}
          ref: ${{ needs.extract_branch_info.outputs.packetDrillBranch }}

      - name: Install TCPDirect Deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential perl


      - name: build
        run: |
          cd $GITHUB_WORKSPACE/tcpdirect
          ONLOAD_TREE=$GITHUB_WORKSPACE/onload_internal NDEBUG=1 make -j $(nproc)

      - name: shim
        run: |
          cd $GITHUB_WORKSPACE/tcpdirect
          ONLOAD_TREE=$GITHUB_WORKSPACE/onload_internal NDEBUG=1 ZF_DEVEL=1 TEST_THREAD_NAME=zf make -j $(nproc) shim

      - name: tests
        run: |
          cd $GITHUB_WORKSPACE/tcpdirect
          ONLOAD_TREE=$GITHUB_WORKSPACE/onload_internal NDEBUG=1 ZF_DEVEL=1 TEST_THREAD_NAME=zf make -j $(nproc) test
